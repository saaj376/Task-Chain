<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Jamboard Replica</title>
    <!-- Use a Google Font to match the clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <!-- For Sticky Notes -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root {
            --primary: #4285f4;
            --bg-gray: #f8f9fa;
            --border: #dadce0;
            --icon-color: #5f6368;
            --icon-hover: #202124;
            --selected-bg: #e8f0fe;
            --selected-color: #1967d2;
            --note-yellow: #fff740;
            --note-green: #ccff90;
            --note-blue: #cbf0f8;
            --note-pink: #fbbc04;
            /* Actually orange in Jamboard, but let's stick to standard set */
            --note-orange: #fbbc04;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f1f3f4;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Top Bar --- */
        .top-bar {
            height: 64px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 16px;
            border-bottom: 1px solid var(--border);
            justify-content: space-between;
            z-index: 100;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .jam-logo {
            width: 32px;
            height: 32px;
            border-radius: 4px;
        }

        .jam-title {
            font-size: 18px;
            color: #202124;
            font-weight: 500;
        }

        .center-tools {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f1f3f4;
            padding: 4px;
            border-radius: 4px;
            /* Optional, Jamboard usually has pages here. We'll put undo/redo */
        }

        .top-tools {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--icon-color);
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.04);
            color: var(--icon-hover);
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .btn-text {
            border: 1px solid var(--border);
            background: white;
            color: var(--icon-color);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-text:hover {
            background: #f8f9fa;
            border-color: #c6c6c6;
        }

        /* --- Canvas Area --- */
        .workspace {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            /* Center the board */
            padding-top: 20px;
            overflow: hidden;
        }

        /* The white drawing board */
        #board-container {
            width: 100%;
            height: 100%;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            position: relative;
            overflow: hidden;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            touch-action: none;
        }

        #main-canvas {
            z-index: 10;
            cursor: crosshair;
        }

        #preview-canvas {
            z-index: 20;
            pointer-events: none;
        }

        #laser-canvas {
            z-index: 25;
            pointer-events: none;
        }

        /* Objects Layer (Notes, Text, Images) */
        #objects-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 30;
            pointer-events: none;
            /* Default: drawing tools active */
        }

        .select-mode #objects-layer {
            pointer-events: auto;
        }

        .select-mode #main-canvas {
            pointer-events: none;
        }

        /* --- Left Toolbar --- */
        .toolbar-left {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            box-shadow: 0 1px 3px rgba(60, 64, 67, 0.3), 0 4px 8px 3px rgba(60, 64, 67, 0.15);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 8px 4px;
            gap: 4px;
            z-index: 100;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--icon-color);
            position: relative;
        }

        .tool-btn:hover {
            color: #202124;
        }

        .tool-btn.active {
            color: var(--selected-color);
            background: var(--selected-bg);
        }

        .tool-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        /* Tiny arrow for dropdowns */
        .caret-right {
            position: absolute;
            right: 2px;
            bottom: 10px;
            font-size: 8px;
            color: inherit;
        }

        /* --- Popups --- */
        .popup-menu {
            position: absolute;
            left: 55px;
            /* Right of toolbar */
            background: white;
            box-shadow: 0 1px 2px 0 rgba(60, 64, 67, 0.3), 0 2px 6px 2px rgba(60, 64, 67, 0.15);
            border-radius: 4px;
            padding: 12px;
            display: none;
            z-index: 200;
            flex-direction: row;
            gap: 12px;
        }

        .popup-menu.show {
            display: flex;
        }

        /* Pen Options */
        .brush-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            border-right: 1px solid #dadce0;
            padding-right: 12px;
        }

        .brush-opt {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .brush-opt:hover {
            background: #f1f3f4;
        }

        .brush-opt.selected {
            background: #e8f0fe;
            color: #1967d2;
        }

        .color-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            border: 2px solid transparent;
        }

        .color-dot.selected::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            border: 2px solid #4285f4;
        }

        /* Shapes Options */
        .shape-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        /* --- DOM Elements (Notes, Text, Images) --- */
        .obj-wrapper {
            position: absolute;
            cursor: grab;
            user-select: none;
            transform-origin: center center;
        }

        .obj-wrapper:active {
            cursor: grabbing;
        }

        .sticky-note {
            width: 200px;
            height: 200px;
            padding: 16px;
            font-family: 'Kalam', cursive;
            font-size: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            outline: none;
            transition: transform 0.1s;
        }

        .text-box {
            min-width: 50px;
            min-height: 30px;
            color: #202124;
            font-size: 24px;
            font-family: 'Roboto', sans-serif;
            /* Could use other fonts */
            background: transparent;
            outline: none;
            border: 1px solid transparent;
            padding: 4px;
            white-space: nowrap;
        }

        .text-box:focus {
            border: 1px solid #4285f4;
        }

        .img-obj {
            max-width: 400px;
            max-height: 400px;
            pointer-events: none;
            /* Wrapper handles events */
            user-select: none;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            right: 0;
            top: 64px;
            bottom: 0;
            width: 300px;
            background: white;
            box-shadow: -2px 0 4px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 150;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            font-weight: bold;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
        }

        .save-item {
            padding: 8px;
            border: 1px solid #eee;
            margin-bottom: 8px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .save-item:hover {
            background: #f8f9fa;
        }
    </style>
</head>

<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <div class="title-section">
            <div
                style="background:#fbbc04; color:white; width:32px; height:32px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px;">
                J</div>
            <div class="jam-title" contenteditable="true">Untitled Jam</div>
        </div>

        <div class="center-tools">
            <!-- Undo/Redo are mostly here in Jamboard? No, they are left, but for space we center them -->
        </div>

        <div class="top-tools">
            <button class="icon-btn" onclick="undo()" title="Undo">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" />
                </svg>
            </button>
            <button class="icon-btn" onclick="redo()" title="Redo">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z" />
                </svg>
            </button>
            <div style="width:1px; height:24px; background:var(--border); margin:0 8px;"></div>
            <button class="btn-text" onclick="toggleSidebar()">Open Saved Jams</button>
            <button class="btn-text" onclick="saveJamToHistory()">Save Frame</button>
            <button class="btn-text" onclick="clearBoard()">Clear frame</button>
            <div style="width:1px; height:24px; background:var(--border); margin:0 8px;"></div>
            <button class="btn-text" onclick="downloadImage()">Download PDF/Img</button>
        </div>
    </div>

    <!-- Workspace -->
    <div class="workspace" id="workspace">

        <!-- Left Toolbar -->
        <div class="toolbar-left">

            <!-- Pen -->
            <button class="tool-btn active" id="tool-pen" onclick="togglePenMenu(event)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                </svg>
                <span class="caret-right">‚ñ∂</span>
            </button>

            <!-- Eraser -->
            <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M15.14 3c-.51 0-1.02.2-1.41.59L2.59 14.73c-.78.78-.78 2.05 0 2.83L5.03 20c.78.78 2.05.78 2.83 0l11.14-11.14c.79-.78.79-2.05 0-2.83l-2.44-2.44c-.39-.39-.91-.59-1.42-.59zm0 2.12L17.59 7.55 12.03 13.11 9.58 10.66 15.14 5.12zM8.17 12.08l2.45 2.45L6.2 18.94 3.75 16.5l4.42-4.42z" />
                </svg>
            </button>

            <!-- Select -->
            <button class="tool-btn" id="tool-select" onclick="setTool('select')">
                <svg viewBox="0 0 24 24">
                    <path d="M7 2l12 11.2-5.8.5 3.3 7.3-2.2.9-3.2-7.4-4.4 4V2z" />
                </svg>
            </button>

            <!-- Sticky Note -->
            <button class="tool-btn" id="tool-note" onclick="addStickyNotePrompt()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z" />
                    <path d="M7 12h10v2H7zm0-4h10v2H7zm0 8h7v2H7z" />
                </svg>
            </button>

            <!-- Add Image -->
            <button class="tool-btn" id="tool-image" onclick="document.getElementById('img-input').click()">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                </svg>
            </button>
            <input type="file" id="img-input" hidden accept="image/*" onchange="handleImageUpload(event)">

            <!-- Shapes -->
            <button class="tool-btn" id="tool-shape" onclick="toggleShapeMenu(event)">
                <span id="curr-shape-icon" style="font-size:18px;">‚ö™</span> <!-- Default circle -->
                <span class="caret-right">‚ñ∂</span>
            </button>

            <!-- Text Box -->
            <button class="tool-btn" id="tool-text" onclick="setTool('text')">
                <svg viewBox="0 0 24 24">
                    <path d="M5 5v3h5v11h3V8h5V5z" />
                </svg>
            </button>

            <!-- Laser -->
            <button class="tool-btn" id="tool-laser" onclick="setTool('laser')">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.43-10.82l-5.66 5.66-2.19-2.2-1.42 1.41 3.61 3.62 7.08-7.07z"
                        fill="none" />
                    <circle cx="12" cy="12" r="6" fill="currentColor" fill-opacity="0.5" />
                </svg>
            </button>

        </div>

        <!-- Persistent Color Palette -->
        <div class="toolbar-left"
            style="left: 70px; top: 50%; transform: translateY(-50%); height: auto; padding: 8px; background: white; box-shadow: 0 1px 3px rgba(60,64,67,0.3); border-radius: 8px; display: flex; flex-direction: column; gap: 8px;">
            <div class="color-dot" style="background:#000000" onclick="setColor('#000000', this)"></div>
            <div class="color-dot" style="background:#d93025" onclick="setColor('#d93025', this)"></div>
            <div class="color-dot" style="background:#1967d2" onclick="setColor('#1967d2', this)"></div>
            <div class="color-dot" style="background:#1e8e3e" onclick="setColor('#1e8e3e', this)"></div>
        </div>

        <!-- Pen Menu Popup -->
        <div class="popup-menu" id="pen-menu">
            <div class="brush-options">
                <div class="brush-opt selected" onclick="setBrush('pen')">üñäÔ∏è</div>
                <div class="brush-opt" onclick="setBrush('marker')">üìù</div>
                <div class="brush-opt" onclick="setBrush('highlighter')">üñçÔ∏è</div>
                <div class="brush-opt" onclick="setBrush('brush')">üñåÔ∏è</div>
            </div>
            <div class="color-options">
                <div class="color-dot" style="background:#000000" onclick="setColor('#000000', this)"></div>
                <div class="color-dot" style="background:#1967d2" onclick="setColor('#1967d2', this)"></div>
                <div class="color-dot" style="background:#1e8e3e" onclick="setColor('#1e8e3e', this)"></div>
                <div class="color-dot" style="background:#d93025" onclick="setColor('#d93025', this)"></div>
                <div class="color-dot" style="background:#fbbc04" onclick="setColor('#fbbc04', this)"></div>
                <div class="color-dot" style="background:#ffffff; border:1px solid #dadce0"
                    onclick="setColor('#ffffff', this)"></div>
            </div>
        </div>

        <!-- Shapes Menu Popup -->
        <div class="popup-menu" id="shapes-menu">
            <div class="shape-grid">
                <div class="brush-opt" onclick="setShape('circle')">‚≠ï</div>
                <div class="brush-opt" onclick="setShape('rect')">‚¨õ</div>
                <div class="brush-opt" onclick="setShape('triangle')">üî∫</div>
                <div class="brush-opt" onclick="setShape('diamond')">üî∂</div>
                <div class="brush-opt" onclick="setShape('arrow')">‚û°</div>
                <div class="brush-opt" onclick="setShape('line')">‚ûñ</div>
            </div>
        </div>

        <!-- Board -->
        <div id="board-container">
            <canvas id="main-canvas"></canvas>
            <canvas id="preview-canvas"></canvas>
            <canvas id="laser-canvas"></canvas> <!-- For laser trails -->
            <div id="objects-layer"></div>
        </div>

    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            SAVED JAMS
            <span style="cursor:pointer" onclick="toggleSidebar()">‚úï</span>
        </div>
        <div id="saved-list"></div>
    </div>

    <!-- Hidden Sticky Note Create Modal (Or simple prompt) -->
    <!-- We'll use JS prompt for simplicity or custom overlay if needed. Let's start with clean JS prompt for "Text" logic, but sticky note should just appear. -->

    <script>
        // --- Robust Whiteboard Logic ---

        // State
        const state = {
            isDrawing: false,
            color: '#000000',
            tool: 'pen',
            lastX: 0, lastY: 0,
            history: [],
            historyStep: -1
        };

        const settings = {
            width: 2,
            cap: 'round'
        };

        // DOM
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('board-container');

        // Resize
        function resize() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.lineWidth = 2;
        }
        window.addEventListener('resize', resize);
        setTimeout(resize, 100);

        // Socket.IO
        let socket;
        try {
            if (typeof io !== 'undefined') {
                socket = io("http://localhost:5000");
                const wbId = "default-wb";

                socket.on("connect", () => {
                    console.log("Socket connected");
                    socket.emit("join_whiteboard", wbId);
                });

                socket.on("draw_update", (data) => {
                    if (data.elements) drawSegment(data.elements);
                });
            } else {
                console.warn("Socket.IO not loaded. Offline mode.");
            }
        } catch (e) { console.error("Socket error", e); }

        // Core Drawing
        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }

        function drawSegment(data) {
            ctx.beginPath();
            ctx.strokeStyle = data.color || state.color;
            ctx.lineWidth = data.width || settings.width;
            ctx.lineCap = data.cap || settings.cap;
            ctx.lineJoin = 'round';

            if (data.x0 !== undefined && data.y0 !== undefined) {
                ctx.moveTo(data.x0, data.y0);
                ctx.lineTo(data.x1, data.y1);
            } else {
                ctx.lineTo(data.x1, data.y1);
            }
            ctx.stroke();
        }

        // Events
        container.addEventListener('mousedown', (e) => {
            state.isDrawing = true;
            const { x, y } = getPos(e);
            state.lastX = x; state.lastY = y;

            // Draw Dot
            ctx.beginPath();
            ctx.fillStyle = state.color;
            ctx.arc(x, y, settings.width / 2, 0, Math.PI * 2);
            ctx.fill();
        });

        window.addEventListener('mousemove', (e) => {
            if (!state.isDrawing) return;
            const { x, y } = getPos(e);

            const segment = {
                x0: state.lastX, y0: state.lastY,
                x1: x, y1: y,
                color: state.color,
                width: settings.width
            };

            // Local Draw
            drawSegment(segment);

            // Network Emit
            if (socket) {
                socket.emit("draw", { wbId: "default-wb", elements: segment });
            }

            state.lastX = x; state.lastY = y;
        });

        window.addEventListener('mouseup', () => {
            state.isDrawing = false;
        });

        // Tools
        window.setColor = (hex, el) => {
            state.color = hex;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            if (el) el.classList.add('selected');
        };

        window.setTool = (t) => {
            state.tool = t;
            if (t === 'eraser') {
                state.color = '#ffffff';
                settings.width = 20;
            } else {
                state.color = '#000000'; // Reset to black or keep prev? Reset for simplicity
                settings.width = 2;
            }
        };

        // Helper functions for UI
        window.clearBoard = () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        window.toggleSidebar = () => { /* Stub */ };
        window.saveJamToHistory = () => { /* Stub */ };
        window.undo = () => { /* Stub */ };
        window.redo = () => { /* Stub */ };
        window.togglePenMenu = () => { /* Stub */ };
        window.toggleShapeMenu = () => { /* Stub */ };
        window.addStickyNotePrompt = () => { /* Stub */ };
        window.handleImageUpload = () => { /* Stub */ };
        window.setBrush = () => { /* Stub */ };
        window.setShape = () => { /* Stub */ };

    </script>


</body>
</html>
